<script src="resources/topics.js"></script>
<script>
    //console.log("Topics loaded:", availableTopics);
    //console.log("Default Topics loaded:", defaultTopicsNodeType);
</script>

<script type="text/javascript">
    function updateAppList(node) {
        let dropdown = $("#node-input-app");
        dropdown.empty(); // On vide la liste avant de la remplir
        console.log("updateAppList START app:", node.app);


        let serverId = $("#node-input-server").val(); // ID du serveur s√©lectionn√©
        if (!serverId) return;

        let serverConfig = RED.nodes.node(serverId); // R√©cup√©rer le n≈ìud serveur
        //console.debug("üîç serverConfig r√©cup√©r√© :", serverConfig);

        if (serverConfig && serverConfig.apps) {
            let apps = serverConfig.apps.split(",");
            console.debug("üìú Liste des applications :", apps);

            apps.forEach(app => {
                dropdown.append(new Option(app, app));
            });

            // üîÑ Attendre la mise √† jour compl√®te avant de restaurer la valeur s√©lectionn√©e
            setTimeout(() => {
                if (node.app && dropdown.find(`option[value="${node.app}"]`).length > 0) {
                    dropdown.val(node.app);
                } else {
                    dropdown.val($("#node-input-app option:first").val());
                }
                console.debug("‚úîÔ∏è Valeur s√©lectionn√©e apr√®s mise √† jour :", dropdown.val());
            }, 50); // Petit d√©lai pour laisser le DOM se mettre √† jour
        } else {
            console.warn("‚ö†Ô∏è Aucun serveur s√©lectionn√© ou liste d'applications vide !");
        }
    }

    // Function to populate the <select>
    function populateTopicsSelect(node) {
        /*
        $.getScript('resources/topics.js', function() {
            console.log("topics.js loaded");
        });
        */
       //const availableTopics = ['StasisStart', 'StasisEnd'];
        console.debug(`debug populateTopicsSelect`);

        const select = $("#node-input-topics");
        select.empty(); // Clear existing options

        availableTopics.forEach(topic => {
            select.append($("<option></option>").attr("value", topic).text(topic));
        });

        // Restore previously selected values or defaults values
        select.val(node.topics || defaultTopicsNodeType[node.type]);  
    }

</script>

<script type="text/javascript">   
    RED.nodes.registerType('ari_listener', {
        category: 'asterisk',
        color: '#989898',
        icon: 'font-awesome/fa-asterisk',
        defaults: {
            name: { value: "Listener" },
            server: { value: "", type: "asterisk_ari", required: true },
            app: { value: "" },
            topics: { value: "" }
        },
        inputs: 1,
        outputs: 2,
        outputLabels: ["starting", "event"],
        label: function () {
            return this.name || "Application";
        },
        palletteLabel: "Application",

        oneditprepare: function () {
            // Call this function when preparing the editor
            
            let node = this;
            // Charger la liste d'applications au d√©marrage
            updateAppList(node);

            // Mettre √† jour la liste quand on change de serveur
            $("#node-input-server").on("change", function () {
                updateAppList(node);
            });

            populateTopicsSelect(node);


        },
        oneditsave: function () {
            // Sauvegarder les valeurs s√©lectionn√©es
            this.app = $("#node-input-app").val();
            this.topics = $('#node-input-topics').val() || defaultTopicsNodeType[this.type];
        }
    });
</script>

<script type="text/html" data-template-name="ari_listener">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-tag"></i>Asterisk</label>
        <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
        <label for="node-input-app"><i class="fa fa-tag"></i>Application</label>
        <select id="node-input-app">
            <!-- Options will be added dynamically -->
        </select>
    </div>
    <div class="form-row" >
        <label for="node-input-topics"><i class="fa fa-tag"></i>Topics</label>
        
        <select id="node-input-topics" name="node-input-topics" size="5" multiple></select>
    </div>
</script>

<!-- Next, some simple help text is provided for the node.                   -->
<script type="text/html" data-help-name="ari_listener">
<!-- data-help-name identifies the node type this help is for             -->
<!-- This content appears in the Info sidebar when a node is selected     -->
<!-- The first <p> is used as the pop-up tool tip when hovering over a    -->
<!-- node in the palette.                                                 -->
<p>This Node-RED node listens for all events from an Asterisk Stasis application and emits messages accordingly.</p>

<p>event values
<ul>
    <li>StasisStart,</li>
    <li>ChannelHangupRequest,</li>
    <li>StasisEnd,</li>
    <li>others...</li>
</ul>
</p>


<h3>Outputs</h3>
<dl class="message-properties">
    <dt>starting</dt>
    <dd>
        <p>Output an object called <b>msg</b> when the stasis application starts.
            msg is composed of
        <ul>
            <li><b>event</b> name (string), </li>
            <li><b>asteriskId</b> identifier of ari asterisk connection (string),</li>
            <li><b>channelId</b> identifier of channel (string) - optional</li>
            <li><b>payload</b> event (object)</li>
            <li><b>_msgid</b> (string).</li>
        </ul>
        </p>
    </dd>
    <dt>event</dt>
    <dd>
        <p>Output an object called <b>msg</b> each time the stasis application receives and event.
            msg is composed of
        <ul>
            <li><b>event</b> name (string), </li>
            <li><b>asteriskId</b> identifier of ari asterisk connection (string),</li>
            <li><b>channelId</b> identifier of channel (string) - optional</li>
            <li><b>payload</b> event (object)</li>
            <li><b>_msgid</b> (string).</li>
        </ul>
        </p>

    </dd>
</dl>

<h3>Details</h3>
<p>
    The node listens to events for the configured stasis application.
    Put this name in the dialplan. ex exten => _+.,1,Stasis(TestApp), to receive events for an incoming call.

</p>

<h3>Node Configuration</h3>
<dl class="message-properties">
    <dt>application name
        <span class="property-type">string</span>
    </dt>
    <dd>
        The name of the stasis application to register. 
        Default: <code>TestApp</code>.
    </dd>

    <dt>Asterisk server
        <span class="property-type">object</span>
    </dt>
    <dd>
        The url of the Asterisk server to use.
    </dd>

</dl>

<h3>Example of Use:</h3>
<p>Connect the Starting output to trigger call-handling logic when a call enters the Stasis application.
    Use the Event output to handle specific Asterisk events such as ChannelDtmfReceived, ChannelHangupRequest, etc.
</p>

<p>
    This node receives all the events for the stasis application configured in the node.
</p>

</script>

<script type="text/javascript">
    RED.nodes.registerType('ari_playback', {
        category: 'asterisk',
        color: '#FF9966',
        icon: 'font-awesome/fa-asterisk',
        defaults: {
            name: { value: "Playback" },
            media2: { value: "" },
            media2Type: { value: "msg" }
        },
        inputs: 1,
        outputs: 2,
        outputLabels: ["end", "event"],
        label: function () {
            return this.name || "Playback";
        },
        palletteLabel: "Playback",

        oneditprepare: function () {
            $('#node-input-media2').typedInput({
                default: '',
                typeField: $("#node-input-media2Type"),
                //type:"msg",
                types: ["msg", "flow", "global", "str"],
            });
        },
        oneditsave: function () {
            //this.exampleText = this.editor.getValue();
            //this.editor.destroy();
            media2Type = $('#node-input-media2Type').val()
            delete this.editor;
        },
        oneditcancel: function () {
            this.editor.destroy();
            delete this.editor;
        },
    });
</script>

<script type="text/html" data-template-name="ari_playback">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i>Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-media2"><i class="fa fa-tag"></i>Or media in var</label>
        <input type="text" id="node-input-media2" style="width:70%" placeholder="sound:weasels-eaten-phonesys">
        <input type="hidden" id="node-input-media2Type">
    </div>
</script>

<!-- Next, some simple help text is provided for the node.                   -->
<script type="text/html" data-help-name="ari_playback">
    <!-- data-help-name identifies the node type this help is for             -->
<!-- This content appears in the Info sidebar when a node is selected     -->
<!-- The first <p> is used as the pop-up tool tip when hovering over a    -->
<!-- node in the palette.                                                 -->
<p>Input and output node. Just sends a sound message when it starts up.
</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('ari_hangup', {
        category: 'asterisk',
        color: '#FF6633',
        icon: 'font-awesome/fa-asterisk',
        defaults: {
            name: { value: "Hangup" }
        },
        inputs: 1,
        outputs: 1,
        outputLabels: ["end"],
        label: function () {
            return this.name || "Hangup";
        },
        palletteLabel: "Hangup"
    });
</script>

<script type="text/html" data-template-name="ari_hangup">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i>Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Next, some simple help text is provided for the node.                   -->
<script type="text/html" data-help-name="ari_hangup">
    <p> Hangup The Channel</p>
 </script>

<!-- ari_answer section  start                                                -->
<script type="text/javascript">
    RED.nodes.registerType('ari_answer', {
        category: 'asterisk',
        color: '#66ff66',
        icon: 'font-awesome/fa-asterisk',
        defaults: {
            name: { value: "Answer" }
        },
        inputs: 1,
        outputs: 1,
        outputLabels: ["answered"],
        label: function () {
            return this.name || "Answer";
        },
        palletteLabel: "Answer"
    });
</script>

<script type="text/html" data-template-name="ari_answer">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i>Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>
<!-- ari_answer section  end                                                -->

<!-- ari_continueindialplan section  start                                                -->
<script type="text/javascript">
    RED.nodes.registerType('ari_continueindialplan', {
        category: 'asterisk',
        color: '#66ff66',
        icon: 'font-awesome/fa-asterisk',
        defaults: {
            name: { value: "Continue in dialplan" }
        },
        inputs: 1,
        outputs: 1,
        outputLabels: ["end"],
        label: function () {
            return this.name || "Continue in dialplan";
        },
        palletteLabel: "Continue in dialplan"
    });
</script>

<script type="text/html" data-template-name="ari_continueindialplan">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i>Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>
<!-- ari_continueindialplan section  end                                                -->

<script type="text/javascript">
    RED.nodes.registerType('ari_bridgedial', {
        category: 'asterisk',
        color: '#339933',
        icon: 'font-awesome/fa-asterisk',
        defaults: {
            name: { value: "Bridge Dial" },
            destination: { value: "" },
            app: { value: "MyApp" },
            callerId: {}
        },
        inputs: 1,
        outputs: 2,
        outputLabels: ["end", "event"],
        label: function () {
            return this.name || "Bridge Dial";
        },
        palletteLabel: "Bridge Dial"
    });
</script>

<script type="text/html" data-template-name="ari_bridgedial">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i>Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-destination"><i class="fa fa-tag"></i>Destination</label>
        <input type="text" id="node-input-destination" placeholder="PJSIP/1000">
    </div>
    <div class="form-row">
        <label for="node-input-callerId"><i class="fa fa-tag"></i>Caller ID</label>
        <input type="text" id="node-input-callerId" placeholder="2000">
    </div>
 </script>

 <script type="text/html" data-help-name="ari_bridgedial">
    <!-- data-help-name identifies the node type this help is for             -->
<!-- This content appears in the Info sidebar when a node is selected     -->
<!-- The first <p> is used as the pop-up tool tip when hovering over a    -->
<!-- node in the palette.                                                 -->
<p>Connect a caller (active channel) to an endpoint</p>
<p>Endpoint can be configured in the node settings, or
    overridden by values in the incoming message's request body (payload.destination property : ex PJSIP/1000) </p>
<p>event values
<ul>
    <li>StasisStart,</li>
    <li>ChannelHangupRequest,</li>
    <li>StasisEnd,</li>
    <li>others...</li>
</ul>
</p>

<h3>Inputs</h3>
<dl class="message-properties">
    <dt>payload
        <span class="property-type">object</span>
    </dt>
    <dd>
        Incoming message's <code>payload</code> can have destination property to define endpoint to call..
    </dd>
</dl>


<h3>Outputs</h3>
<dl class="message-properties">
    <dt>Event</dt>
    <dd>
        <p>Output an object called <b>msg</b> containing
            <b>msg.payload</b>. msg.payload is composed of
        <ul>
            <li><b>event</b> (string), </li>
            <li><b>channel</b> (object),</li>
            <li><b>details</b> (object)</li>
            <li><b>_msgid</b> (string).</li>

        </ul>
        </p>
    </dd>
    <dt>Dtmf</dt>
    <dd>
        <p>Output an object called <b>msg</b> containing
            <b>msg.payload</b>. msg.payload is composed of
        <ul>
            <li><b>event</b> (string), </li>
        </ul>
        </p>

    </dd>
    <dt>Debug</dt>
    <dd>
        <p>Output an object called <b>msg</b> containing
            <b>msg.payload</b>. msg.payload is composed of
        <ul>
            <li><b>event</b> name (string), </li>
            <li><b>asteriskId</b> identifier of ari asterisk connection (string),</li>
            <li><b>channelId</b> identifier of channel (string)  - optional</li>
            <li><b>payload</b> event (object)</li>
            <li><b>_msgid</b> (string).</li>
        </ul>
        </p>
    </dd>
</dl>

<h3>Details</h3>
<p>
    to be completed..
<ul>
    <li>Each incoming message's ...</li>
    <li>Once </li>
    <li>Then </li>
</ul>
</p>

<h3>Node Configuration</h3>
<dl class="message-properties">
    <dt>destination
        <span class="property-type">string</span>
    </dt>
    <dd>
        Endpoint to call.
    </dd>

    <dt>callerid
        <span class="property-type">string</span>
    </dt>
    <dd>
        Identifier of the caller (optional).
    </dd>

</dl>

<h3>Examples of Use:</h3>
<ul>
    <li><strong>Example 1:</strong>
        <ul>
            
        </ul>
    </li>
</ul>


</script>

 
<!-- ari_bridgedial section  end                                                -->

<script type="text/javascript">
    RED.nodes.registerType('ari_originate', {
        category: 'asterisk',
        color: '#339933',
        icon: 'font-awesome/fa-asterisk',
        defaults: {
            name: { value: "Originate" },
            server: { value: "", type: "asterisk_ari", required: true },
            app: { value: "" },
            topics: { value: "" },
            destination: { value: "" },
            callerId: {}
        },
        inputs: 1,
        outputs: 2,
        outputLabels: ["calling", "event"],
        label: function () {
            return this.name || "Originate";
        },
        palletteLabel: "Originate",
        oneditprepare: function () {
            console.debug("ari_originate - oneditprepare START");
            let node = this;

            // Charger la liste d'applications au d√©marrage
            updateAppList(node);

            // Mettre √† jour la liste quand on change de serveur
            $("#node-input-server").on("change", function () {
                updateAppList(node);
            });

            populateTopicsSelect(node);

        },
        oneditsave: function () {
            let app = $("#node-input-app").val();
            console.log(`üîç oneditsave - app: ${app}`);
            
            if (!app) {
                console.warn("‚ö†Ô∏è Aucune valeur s√©lectionn√©e pour app !");
            }
            // Sauvegarder les valeurs s√©lectionn√©es
            this.app = $("#node-input-app").val();
            this.topics = $('#node-input-topics').val() || defaultTopicsNodeType[this.type];
        }
    });
</script>

<script type="text/html" data-template-name="ari_originate">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i>Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-tag"></i>Asterisk</label>
        <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
        <label for="node-input-app"><i class="fa fa-tag"></i>Application</label>
        <select id="node-input-app">
            <!-- Options will be added dynamically -->
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-topics"><i class="fa fa-tag"></i>Topics</label>
        <select id="node-input-topics" name="node-input-topics" size="5" multiple></select>
    </div>
    <div class="form-row">
        <label for="node-input-destination"><i class="fa fa-tag"></i>Endpoint</label>
        <input type="text" id="node-input-destination" placeholder="PJSIP/number[@trunk name]">
    </div>
    <div class="form-row">
        <label for="node-input-callerId"><i class="fa fa-tag"></i>Caller ID</label>
        <input type="text" id="node-input-callerId" placeholder="2000">
    </div>
 </script>

 <script type="text/html" data-help-name="ari_originate">
    <!-- data-help-name identifies the node type this help is for             -->
<!-- This content appears in the Info sidebar when a node is selected     -->
<!-- The first <p> is used as the pop-up tool tip when hovering over a    -->
<!-- node in the palette.                                                 -->
<p>Define and registered an ari application, call an endpoint and receive all the events to the application</p>
<p>Endpoint can be configured in the node settings, or
    overridden by values in the incoming message's request body (payload.destination property : ex PJSIP/1000) </p>
<p>event values
<ul>
    <li>StasisStart,</li>
    <li>ChannelHangupRequest,</li>
    <li>StasisEnd,</li>
    <li>others...</li>
</ul>
</p>

<h3>Inputs</h3>
<dl class="message-properties">
    <dt>payload
        <span class="property-type">object</span>
    </dt>
    <dd>
        Incoming message's <code>payload</code> can have destination property to define endpoint to call..
    </dd>
</dl>


<h3>Outputs</h3>
<dl class="message-properties">
    <dt>Event</dt>
    <dd>
        <p>Output an object called <b>msg</b> containing
            <b>msg.payload</b>. msg.payload is composed of
        <ul>
            <li><b>event</b> (string), </li>
            <li><b>channel</b> (object),</li>
            <li><b>details</b> (object)</li>
            <li><b>_msgid</b> (string).</li>

        </ul>
        </p>
    </dd>
    <dt>Dtmf</dt>
    <dd>
        <p>Output an object called <b>msg</b> containing
            <b>msg.payload</b>. msg.payload is composed of
        <ul>
            <li><b>event</b> (string), </li>
        </ul>
        </p>

    </dd>
    <dt>Debug</dt>
    <dd>
        <p>Output an object called <b>msg</b> containing
            <b>msg.payload</b>. msg.payload is composed of
        <ul>
            <li><b>event</b> name (string), </li>
            <li><b>asteriskId</b> identifier of ari asterisk connection (string),</li>
            <li><b>channelId</b> identifier of channel (string)  - optional</li>
            <li><b>payload</b> event (object)</li>
            <li><b>_msgid</b> (string).</li>
        </ul>
        </p>
    </dd>
</dl>

<h3>Details</h3>
<p>
    to be completed..
<ul>
    <li>Each incoming message's ...</li>
    <li>Once </li>
    <li>Then </li>
</ul>
</p>

<h3>Node Configuration</h3>
<dl class="message-properties">
    <dt>application name
        <span class="property-type">string</span>
    </dt>
    <dd>
        The name of the stasis application to register. This application didn't require to be declared in the dialplan.
        Default: <code>Originate</code>.
    </dd>

    <dt>Asterisk server
        <span class="property-type">object</span>
    </dt>
    <dd>
        The id of the Asterisk server to use.
    </dd>

</dl>

<h3>Examples of Use:</h3>
<ul>
    <li><strong>Example 1:</strong>
        <ul>
            <li>Configuration: <code>bufferSize=2</code>, <code>flushInterval=5000</code>.</li>
            <li>Behavior: After receiving two messages,</li>
        </ul>
    </li>
</ul>

<p>
    This node receives all the events for the stasis application.
</p>

</script>

<!-- ari_originate section  end                                                -->


<script type="text/javascript">
    RED.nodes.registerType('ari_dtmf_listen', {
        category: 'asterisk',
        color: '#66ff66',
        icon: 'font-awesome/fa-asterisk',
        defaults: {
            name: { value: "Dtmf_listen" }
        },
        inputs: 1,
        outputs: 1,
        outputLabels: ["dtmf"],
        label: function () {
            return this.name || "Dtmf_listen";
        },
        palletteLabel: "Dtmf_listen"
    });
</script>

<script type="text/html" data-template-name="ari_dtmf_listen">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i>Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Next, some simple help text is provided for the node.                   -->
<script type="text/html" data-help-name="ari_dtmf_listen">
    <p> Dtmf received</p>
 </script>

 <!-- ari_dtmf_listen section  end                                                -->